<svg xmlns="http://www.w3.org/2000/svg"
  xmlns:xlink="http://www.w3.org/1999/xlink"
  version="1.1">
  <script xlink:href="/javascripts/prototype.js" />
  <script xlink:href="/javascripts/annotations_svg.js" />
  <script xlink:href="/javascripts/SourceCodeGlower/AnnotationTextDisplayer.js"/>
  <script xlink:href="/javascripts/SourceCodeGlower/AnnotationText.js"/>
  <style type="text/css">
      @import url(/stylesheets/svg_style.css);
      @import url(/stylesheets/main.css);
  </style>
  <image x="0" y="0"
      width="100%" height="100%"
      style="z-index: 0;"
  xlink:href="<%= url_for(:action => 'download',
                          :controller => 'results',
              :select_file_id => @submission_file.id,
              :show_in_browser => true) -%>" />

  <g id="shapes">
  <% @annotations.each do |annotation| %>
  <g id="shape_<%= annotation.id%>">
<% if annotation.type == "ShapeAnnotation" %>
    <%
     paths = []
     currentPath = ""
     annotation.points.each do |point|
       # Split the shape in several paths, this is due to the fact that svg
       # uses the shape outlined by the path rather than the path itself to
       # detect mouseover events
       if currentPath == ""
         # First point of the shape
         currentPath = "M" + point.coord_x.to_s  + "," + point.coord_y.to_s
       elsif currentPath.split.length >= 9
         # Duplicate the last point of the path
         currentPath += " L" + point.coord_x.to_s  + "," + point.coord_y.to_s
         paths.push(currentPath)
         currentPath = "M" + point.coord_x.to_s  + "," + point.coord_y.to_s
       else
         # Normal point within a path
         currentPath += " L" + point.coord_x.to_s + "," + point.coord_y.to_s
       end
     end

     paths.push(currentPath)
    %>
    <% paths.each do |path| %>
      <path style="stroke: <%= annotation.color %>; stroke-width: <%= annotation.thickness%>px" d="<%= path %>" />
    <% end %>
<% elsif annotation.type == "AreaAnnotation" %>
     <rect id="area_<%= annotation.id%>"x="<%= annotation.x1%>" y="<%= annotation.y1%>"
     width="<%= (annotation.y2 - annotation.y1)%>"
     height="<%= (annotation.x2 - annotation.x1)%>"
     />
<% end %>
  </g>
<% end %>
  </g>
  <g id="annotations">
<% @annotations.each do |annotation| %>
  <g id="annotation_<%= annotation.id%>">
  <text><%= annotation.annotation_text.content %></text>
  </g>
<% end %>
</g>

  <g id="toolbar">
    <rect x="0" y="0" width="140" height="26" />
    <image x="30" y="5"
      width="16" height="16"
      id="button_shape"
      xlink:href = "/images/icons/pencil.png"
    />
    <image x="55" y="5"
      width="16" height="16"
      id="button_area"
      xlink:href = "/images/icons/shape_square_add.png"
    />
    <image x ="5" y="5"
      width="16" height="16"
      id="button_view"
      xlink:href = "/images/icons/eye.png"
    />
    <image x="80" y="5" z-index = "0"
      width="16" height="16"
      id="button_delete"
      xlink:href = "/images/icons/comment_delete.png"
    />
    <image x="105" y="5"
      width="16" height="16"
      id="button_save"
      xlink:href = "/images/icons/disk.png"
      />
  </g>

  <!-- Process the embedded XHTML -->
  <g id="modal">
  <foreignObject width="1000" height="500"
                 x="0" y="50">
    <!-- XHTML content goes here -->
    <body xmlns="http://www.w3.org/1999/xhtml">
      <div id="create_annotation_dialog"> <!--  style="display:none;"> -->
      <h2><%= I18n.t("marker.annotation.new_annotation") %></h2>
      <p>
      <textarea id="new_annotation_content" rows="3" cols="42" onclick="this.focus()"></textarea>
      </p>
      <h3><%= I18n.t("marker.annotation.annotation_category") %></h3>
      <select id="new_annotation_category">
      <option value=""><%=t('annotations.one_time_only')%></option>
      <% @annotation_categories.each do |annotation_category| %>
        <option value="<%=h(annotation_category.id)%>"><%=h(annotation_category.annotation_category_name)%></option>
      <% end %>
      </select>
      <p style="margin-top: 5px; border-top: 1px solid #000000; padding-top: 10px;">
      <button onclick="submit_new_annotation($F('new_annotation_content'), $F('new_annotation_category'), $F('x1'), $F('x2'), $F('y1'), $F('y2'));"><%= I18n.t("marker.annotation.new_annotation") %></button>
      <button onclick="modal.close();"><%= I18n.t("cancel") %></button>
      </p>

      </div>

    </body>
  </foreignObject>
  </g>  <script>
    //<![CDATA[
    Handler.queryURI = "<%= url_for(:controller =>"annotations" ,
                                     :action =>"write_annotations",
                                    :submission_file_id => @submission_file_id) %>";
    //]]>
  </script>
</svg>
